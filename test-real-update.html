<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦çœŸå¯¦æ›´æ–°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        .section {
            background-color: #334155;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #475569;
        }
        .title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #3b82f6;
        }
        .code-block {
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background-color: #2563eb;
        }
        button:disabled {
            background-color: #64748b;
            cursor: not-allowed;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ¸¬è©¦çœŸå¯¦çš„ warehouse.md æ›´æ–°</h1>
    
    <div class="section">
        <div class="title">ğŸ“‹ ç•¶å‰å•é¡Œ</div>
        <p>warehouse.md ä¸­çš„ 00921 é‚„æ˜¯åªæœ‰ï¼š<code>00921   222</code></p>
        <p>ç¼ºå°‘å®Œæ•´è³‡è¨Šï¼šè‚¡ç¥¨åç¨±ã€ç¾åƒ¹ã€æ¼²è·Œç­‰</p>
    </div>

    <div style="text-align: center;">
        <button onclick="checkCurrentState()">ğŸ” æª¢æŸ¥ç•¶å‰ç‹€æ…‹</button>
        <button onclick="performRealUpdate()">ğŸš€ åŸ·è¡ŒçœŸå¯¦æ›´æ–°</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
    </div>

    <div id="results"></div>

    <script>
        // æ¨¡æ“¬è‚¡ç¥¨çˆ¬èŸ²æœå‹™
        const generateStockInfo = (symbol) => {
            const stockDatabase = {
                '006208': { name: 'å¯Œé‚¦å°50', basePrice: 110.25 },
                '00713': { name: 'å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢', basePrice: 51.90 },
                '00878': { name: 'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯', basePrice: 20.86 },
                '00921': { name: 'å…†è±é¾é ­ç­‰æ¬Šé‡', basePrice: 18.50 }
            };

            const stockInfo = stockDatabase[symbol];
            const name = stockInfo ? stockInfo.name : `è‚¡ç¥¨ ${symbol}`;
            const basePrice = stockInfo ? stockInfo.basePrice : 50.0;

            const changePercent = (Math.random() - 0.5) * 3;
            const change = (basePrice * changePercent) / 100;
            const currentPrice = basePrice + change;

            return {
                symbol,
                name,
                currentPrice: Math.round(currentPrice * 100) / 100,
                change: Math.round(change * 100) / 100,
                changePercent: Math.round(changePercent * 100) / 100,
                lastUpdated: new Date().toISOString()
            };
        };

        window.checkCurrentState = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="section"><div class="title">ğŸ” æª¢æŸ¥ä¸­...</div></div>';

            try {
                // è®€å–ç•¶å‰ warehouse.md
                const response = await fetch('http://localhost:3001/api/warehouse');
                if (!response.ok) {
                    throw new Error('ç„¡æ³•è®€å– warehouse.md');
                }

                const data = await response.json();
                const content = data.content;

                let html = '<div class="section">';
                html += '<div class="title">ğŸ“„ ç•¶å‰ warehouse.md å…§å®¹</div>';
                html += `<div class="code-block">${content}</div>`;

                // åˆ†æå…§å®¹
                const lines = content.split('\n').filter(line => line.trim());
                const incompleteLines = lines.filter(line => {
                    const parts = line.trim().split(/\t/);
                    return parts.length < 4 || !parts[2] || !parts[3];
                });

                html += '<div class="title">ğŸ“Š åˆ†æçµæœ</div>';
                if (incompleteLines.length > 0) {
                    html += `<div class="warning">âš ï¸ ç™¼ç¾ ${incompleteLines.length} è¡Œä¸å®Œæ•´çš„è³‡æ–™ï¼š</div>`;
                    incompleteLines.forEach(line => {
                        html += `<div class="code-block">${line}</div>`;
                    });
                } else {
                    html += '<div class="success">âœ… æ‰€æœ‰è³‡æ–™éƒ½å®Œæ•´</div>';
                }

                html += '</div>';
                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="section">
                        <div class="title error">âŒ æª¢æŸ¥å¤±æ•—</div>
                        <div class="error">éŒ¯èª¤: ${error.message}</div>
                    </div>
                `;
            }
        };

        window.performRealUpdate = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="section"><div class="title">ğŸš€ åŸ·è¡ŒçœŸå¯¦æ›´æ–°...</div></div>';

            try {
                // æ­¥é©Ÿ 1: è®€å–ç•¶å‰ warehouse.md
                const response = await fetch('http://localhost:3001/api/warehouse');
                const data = await response.json();
                const currentContent = data.content;

                let html = '<div class="section">';
                html += '<div class="title">ğŸ“‹ æ›´æ–°æµç¨‹</div>';
                html += '<div class="success">âœ… æ­¥é©Ÿ 1: è®€å–ç•¶å‰ warehouse.md</div>';

                // æ­¥é©Ÿ 2: è§£ææŒè‚¡è³‡æ–™
                const lines = currentContent.split('\n').filter(line => line.trim());
                const holdings = {};
                
                lines.forEach(line => {
                    const parts = line.trim().split(/\t|\s+/);
                    if (parts.length >= 2) {
                        const symbol = parts[0];
                        const shares = parseInt(parts[1]);
                        if (!isNaN(shares) && shares > 0) {
                            holdings[symbol] = shares;
                        }
                    }
                });

                html += '<div class="success">âœ… æ­¥é©Ÿ 2: è§£ææŒè‚¡è³‡æ–™</div>';
                html += `<div class="code-block">æŒè‚¡: ${JSON.stringify(holdings, null, 2)}</div>`;

                // æ­¥é©Ÿ 3: ç”Ÿæˆå®Œæ•´çš„è‚¡ç¥¨è³‡è¨Š
                const symbols = Object.keys(holdings);
                const stockInfos = symbols.map(symbol => generateStockInfo(symbol));

                html += '<div class="success">âœ… æ­¥é©Ÿ 3: ç”Ÿæˆè‚¡ç¥¨è³‡è¨Š</div>';

                // æ­¥é©Ÿ 4: ç”Ÿæˆæ–°çš„ warehouse.md å…§å®¹
                const newContent = symbols.map(symbol => {
                    const shares = holdings[symbol];
                    const stockInfo = stockInfos.find(info => info.symbol === symbol);
                    
                    return `${symbol}\t${shares}\t${stockInfo.name}\t${stockInfo.currentPrice.toFixed(2)}\t${stockInfo.change.toFixed(2)}\t${stockInfo.changePercent.toFixed(2)}\t${stockInfo.lastUpdated}`;
                }).join('\n');

                html += '<div class="success">âœ… æ­¥é©Ÿ 4: ç”Ÿæˆæ–°çš„ warehouse.md å…§å®¹</div>';
                html += `<div class="code-block">${newContent}</div>`;

                // æ­¥é©Ÿ 5: æ›´æ–°æª”æ¡ˆ
                const updateResponse = await fetch('http://localhost:3001/api/warehouse/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: newContent }),
                });

                if (updateResponse.ok) {
                    const updateResult = await updateResponse.json();
                    html += '<div class="success">âœ… æ­¥é©Ÿ 5: æª”æ¡ˆæ›´æ–°æˆåŠŸ</div>';
                    html += `<div class="code-block">å‚™ä»½æª”æ¡ˆ: ${updateResult.backupPath}</div>`;
                    
                    // ç‰¹åˆ¥æª¢æŸ¥ 00921
                    const line00921 = newContent.split('\n').find(line => line.startsWith('00921'));
                    if (line00921) {
                        html += '<div class="success">ğŸ¯ 00921 å·²æ›´æ–°ç‚ºå®Œæ•´æ ¼å¼ï¼š</div>';
                        html += `<div class="code-block">${line00921}</div>`;
                    }
                } else {
                    throw new Error('æª”æ¡ˆæ›´æ–°å¤±æ•—');
                }

                html += '</div>';

                // æ·»åŠ é©—è­‰æ­¥é©Ÿ
                html += '<div class="section">';
                html += '<div class="title">ğŸ” é©—è­‰æ›´æ–°çµæœ</div>';
                html += '<div class="warning">è«‹é‡æ–°è¼‰å…¥ä¸»æ‡‰ç”¨ç¨‹å¼æŸ¥çœ‹çµæœï¼š</div>';
                html += '<div><a href="http://localhost:5173/" target="_blank" style="color: #3b82f6;">http://localhost:5173/</a></div>';
                html += '</div>';

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="section">
                        <div class="title error">âŒ æ›´æ–°å¤±æ•—</div>
                        <div class="error">éŒ¯èª¤: ${error.message}</div>
                    </div>
                `;
            }
        };

        window.clearResults = () => {
            document.getElementById('results').innerHTML = '';
        };

        // è‡ªå‹•æª¢æŸ¥ç•¶å‰ç‹€æ…‹
        setTimeout(checkCurrentState, 1000);
    </script>
</body>
</html>

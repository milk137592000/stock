<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦å®Œæ•´æ•¸æ“šæµç¨‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        .step {
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .step-title {
            font-size: 18px;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 10px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        .stock-info {
            background-color: #475569;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        button:disabled {
            background-color: #64748b;
            cursor: not-allowed;
        }
        .flow-diagram {
            background-color: #1e293b;
            border: 2px solid #475569;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .arrow {
            color: #10b981;
            font-size: 24px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ å®Œæ•´æ•¸æ“šæµç¨‹æ¸¬è©¦</h1>
    
    <div class="flow-diagram">
        <h2>æ•¸æ“šæµç¨‹åœ–</h2>
        <div>ğŸ“Š <strong>çˆ¬èŸ²</strong> (StockCrawlerService)</div>
        <div class="arrow">â¬‡ï¸</div>
        <div>ğŸ“ <strong>æ›´æ–° warehouse.md</strong> (autoUpdateWarehouseContent)</div>
        <div class="arrow">â¬‡ï¸</div>
        <div>ğŸ“– <strong>è®€å– warehouse.md</strong> (handleWarehouseUpdated)</div>
        <div class="arrow">â¬‡ï¸</div>
        <div>ğŸ¯ <strong>æ›´æ–°å¡ç‰‡è³‡è¨Š</strong> (currentAllStocksMap)</div>
    </div>

    <button onclick="testCompleteFlow()">ğŸš€ æ¸¬è©¦å®Œæ•´æµç¨‹</button>
    <button onclick="testCurrentWarehouse()">ğŸ“– æª¢æŸ¥ç•¶å‰ warehouse.md</button>
    <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
    
    <div id="results"></div>

    <script type="module">
        // æ¨¡æ“¬å®Œæ•´çš„æ•¸æ“šæµç¨‹
        window.testCompleteFlow = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">é–‹å§‹æ¸¬è©¦å®Œæ•´æµç¨‹...</div>';

            try {
                // Step 1: çˆ¬èŸ²
                await addStep('step1', 'ğŸ“Š Step 1: çˆ¬èŸ²ç²å–è‚¡ç¥¨è³‡æ–™', 'æ­£åœ¨çˆ¬å–è‚¡ç¥¨è³‡è¨Š...');
                
                // æ¨¡æ“¬çˆ¬èŸ²æœå‹™
                const mockStockData = [
                    {
                        symbol: '006208',
                        name: 'å¯Œé‚¦å°50',
                        currentPrice: 110.25,
                        change: 0.35,
                        changePercent: 0.32,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        symbol: '00713',
                        name: 'å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢',
                        currentPrice: 51.90,
                        change: 0.10,
                        changePercent: 0.19,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        symbol: '00878',
                        name: 'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯',
                        currentPrice: 20.86,
                        change: 0.02,
                        changePercent: 0.10,
                        lastUpdated: new Date().toISOString()
                    }
                ];

                await delay(1000);
                updateStep('step1', 'âœ… çˆ¬èŸ²å®Œæˆ', `æˆåŠŸç²å– ${mockStockData.length} æª”è‚¡ç¥¨è³‡æ–™`, 'success');

                // Step 2: ç”Ÿæˆ warehouse.md å…§å®¹
                await addStep('step2', 'ğŸ“ Step 2: ç”Ÿæˆæ–°çš„ warehouse.md å…§å®¹', 'æ­£åœ¨æ ¼å¼åŒ–è³‡æ–™...');
                
                const mockHoldings = { '006208': 289, '00713': 1133, '00878': 1572 };
                const warehouseContent = mockStockData.map(stock => {
                    const shares = mockHoldings[stock.symbol] || 0;
                    return `${stock.symbol}\t${shares}\t${stock.name}\t${stock.currentPrice.toFixed(2)}\t${stock.change.toFixed(2)}\t${stock.changePercent.toFixed(2)}\t${stock.lastUpdated}`;
                }).join('\n');

                await delay(500);
                updateStep('step2', 'âœ… warehouse.md å…§å®¹ç”Ÿæˆå®Œæˆ', 
                    `<div class="stock-info">${warehouseContent}</div>`, 'success');

                // Step 3: æ¨¡æ“¬è®€å–å’Œè§£æ
                await addStep('step3', 'ğŸ“– Step 3: è§£æ warehouse.md å…§å®¹', 'æ­£åœ¨è§£æè³‡æ–™...');
                
                const lines = warehouseContent.split('\n');
                const parsedData = [];
                
                for (const line of lines) {
                    const parts = line.split('\t');
                    if (parts.length >= 4) {
                        parsedData.push({
                            symbol: parts[0],
                            shares: parseInt(parts[1]),
                            name: parts[2],
                            currentPrice: parseFloat(parts[3]),
                            change: parseFloat(parts[4]),
                            changePercent: parseFloat(parts[5])
                        });
                    }
                }

                await delay(500);
                updateStep('step3', 'âœ… è§£æå®Œæˆ', `æˆåŠŸè§£æ ${parsedData.length} æª”è‚¡ç¥¨è³‡æ–™`, 'success');

                // Step 4: æ›´æ–°å¡ç‰‡è³‡è¨Š
                await addStep('step4', 'ğŸ¯ Step 4: æ›´æ–°å¡ç‰‡è³‡è¨Š', 'æ­£åœ¨æ›´æ–°UI...');
                
                let cardInfo = '<div style="display: grid; gap: 10px;">';
                parsedData.forEach(stock => {
                    const changeColor = stock.change >= 0 ? '#10b981' : '#ef4444';
                    const changeSign = stock.change >= 0 ? '+' : '';
                    cardInfo += `
                        <div class="stock-info">
                            <strong>${stock.symbol} - ${stock.name}</strong><br>
                            æŒè‚¡: ${stock.shares} è‚¡<br>
                            ç¾åƒ¹: <span style="color: #3b82f6;">$${stock.currentPrice}</span><br>
                            æ¼²è·Œ: <span style="color: ${changeColor};">${changeSign}${stock.change} (${changeSign}${stock.changePercent}%)</span>
                        </div>
                    `;
                });
                cardInfo += '</div>';

                await delay(500);
                updateStep('step4', 'âœ… å¡ç‰‡è³‡è¨Šæ›´æ–°å®Œæˆ', cardInfo, 'success');

                // å®Œæˆ
                await addStep('complete', 'ğŸ‰ æµç¨‹å®Œæˆ', 
                    'âœ… å®Œæ•´çš„æ•¸æ“šæµç¨‹æ¸¬è©¦æˆåŠŸï¼<br>çˆ¬èŸ² â†’ warehouse.md â†’ è®€å–è§£æ â†’ å¡ç‰‡æ›´æ–°', 'success');

            } catch (error) {
                await addStep('error', 'âŒ æµç¨‹å¤±æ•—', `éŒ¯èª¤: ${error.message}`, 'error');
            }
        };

        window.testCurrentWarehouse = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info">æª¢æŸ¥ç•¶å‰ warehouse.md...</div>';

            try {
                const response = await fetch('/warehouse.md');
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è®€å– warehouse.md: ${response.status}`);
                }

                const content = await response.text();
                const lines = content.split('\n').filter(line => line.trim());
                
                let html = `<div class="step">
                    <div class="step-title">ğŸ“– ç•¶å‰ warehouse.md å…§å®¹</div>
                    <div class="stock-info">${content}</div>
                    <div class="info">å…± ${lines.length} è¡Œè³‡æ–™</div>
                </div>`;

                // è§£æä¸¦é¡¯ç¤º
                html += `<div class="step">
                    <div class="step-title">ğŸ“Š è§£æçµæœ</div>`;
                
                lines.forEach((line, index) => {
                    const parts = line.trim().split(/\t/);
                    if (parts.length >= 2) {
                        html += `<div class="stock-info">
                            ç¬¬${index + 1}è¡Œ: ${parts[0]} | æŒè‚¡: ${parts[1]} | 
                            ${parts[2] ? `åç¨±: ${parts[2]}` : ''} | 
                            ${parts[3] ? `ç¾åƒ¹: $${parts[3]}` : ''}
                        </div>`;
                    }
                });
                
                html += '</div>';
                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ éŒ¯èª¤: ${error.message}</div>`;
            }
        };

        window.clearResults = () => {
            document.getElementById('results').innerHTML = '';
        };

        // è¼”åŠ©å‡½æ•¸
        async function addStep(id, title, message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const stepDiv = document.createElement('div');
            stepDiv.id = id;
            stepDiv.className = 'step';
            stepDiv.innerHTML = `
                <div class="step-title">${title}</div>
                <div class="${type}">${message}</div>
            `;
            resultsDiv.appendChild(stepDiv);
        }

        function updateStep(id, title, message, type = 'info') {
            const stepDiv = document.getElementById(id);
            if (stepDiv) {
                stepDiv.innerHTML = `
                    <div class="step-title">${title}</div>
                    <div class="${type}">${message}</div>
                `;
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>

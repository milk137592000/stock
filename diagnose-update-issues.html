<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ºæ–·æ›´æ–°å•é¡Œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        .diagnostic-card {
            background-color: #334155;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #475569;
        }
        .diagnostic-card.success {
            border-color: #10b981;
            background-color: #065f46;
        }
        .diagnostic-card.error {
            border-color: #ef4444;
            background-color: #7f1d1d;
        }
        .diagnostic-card.warning {
            border-color: #f59e0b;
            background-color: #7c2d12;
        }
        .title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #3b82f6;
        }
        .test-result {
            background-color: #475569;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        .test-result.pass {
            background-color: #065f46;
            border-left: 4px solid #10b981;
        }
        .test-result.fail {
            background-color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2563eb;
        }
        button:disabled {
            background-color: #64748b;
            cursor: not-allowed;
        }
        .log-entry {
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è¨ºæ–·æ›´æ–°å•é¡Œ</h1>
    
    <div class="diagnostic-card">
        <div class="title">ğŸ¯ å•é¡Œæè¿°</div>
        <p>ç”¨æˆ¶åæ˜ ï¼š</p>
        <ul>
            <li>âŒ ä¸èƒ½è‡ªå‹•çˆ¬èŸ²äº†</li>
            <li>âŒ æŒ‰æ‰‹å‹•æ›´æ–°ä¹Ÿä¸è¡Œ</li>
        </ul>
    </div>

    <div style="text-align: center;">
        <button onclick="runDiagnostics()">ğŸ” é–‹å§‹è¨ºæ–·</button>
        <button onclick="testCrawler()">ğŸ•·ï¸ æ¸¬è©¦çˆ¬èŸ²</button>
        <button onclick="testManualUpdate()">ğŸ”§ æ¸¬è©¦æ‰‹å‹•æ›´æ–°</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
    </div>

    <div id="results"></div>

    <script type="module">
        // æ¨¡æ“¬è‚¡ç¥¨çˆ¬èŸ²æœå‹™
        class TestStockCrawlerService {
            static generateMockStockInfo(symbol) {
                const stockDatabase = {
                    '006208': { name: 'å¯Œé‚¦å°50', basePrice: 110.25 },
                    '00713': { name: 'å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢', basePrice: 51.90 },
                    '00878': { name: 'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯', basePrice: 20.86 },
                    '00921': { name: 'å…†è±é¾é ­ç­‰æ¬Šé‡', basePrice: 18.50 }
                };

                const stockInfo = stockDatabase[symbol];
                const name = stockInfo ? stockInfo.name : `è‚¡ç¥¨ ${symbol}`;
                const basePrice = stockInfo ? stockInfo.basePrice : Math.random() * 100 + 20;

                const changePercent = (Math.random() - 0.5) * 3;
                const change = (basePrice * changePercent) / 100;
                const currentPrice = basePrice + change;

                return {
                    symbol,
                    name,
                    currentPrice: Math.round(currentPrice * 100) / 100,
                    change: Math.round(change * 100) / 100,
                    changePercent: Math.round(changePercent * 100) / 100,
                    lastUpdated: new Date().toISOString()
                };
            }

            static async fetchStockInfo(symbol) {
                try {
                    console.log(`é–‹å§‹çˆ¬å–è‚¡ç¥¨ ${symbol}...`);
                    
                    // æ¨¡æ“¬ç¶²è·¯å»¶é²
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const stockInfo = this.generateMockStockInfo(symbol);
                    console.log(`æˆåŠŸç”Ÿæˆ ${symbol} çš„æ¨¡æ“¬è³‡æ–™:`, stockInfo);
                    return stockInfo;
                } catch (error) {
                    console.error(`çˆ¬å–è‚¡ç¥¨ ${symbol} è³‡è¨Šå¤±æ•—:`, error);
                    throw error;
                }
            }

            static async fetchMultipleStocks(symbols) {
                console.log('é–‹å§‹æ‰¹é‡çˆ¬å–è‚¡ç¥¨:', symbols);
                const results = [];
                
                try {
                    const promises = symbols.map(symbol => this.fetchStockInfo(symbol));
                    const settledResults = await Promise.allSettled(promises);
                    
                    settledResults.forEach((result, index) => {
                        if (result.status === 'fulfilled' && result.value) {
                            results.push(result.value);
                        } else {
                            console.warn(`ç„¡æ³•ç²å–è‚¡ç¥¨ ${symbols[index]} çš„è³‡è¨Š:`, result.reason);
                        }
                    });

                    console.log('æ‰¹é‡çˆ¬å–å®Œæˆ:', results);
                    return results;
                } catch (error) {
                    console.error('æ‰¹é‡çˆ¬å–å¤±æ•—:', error);
                    throw error;
                }
            }
        }

        window.runDiagnostics = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="diagnostic-card"><div class="title">ğŸ” è¨ºæ–·ä¸­...</div></div>';

            let html = '';

            // æ¸¬è©¦ 1: æª¢æŸ¥å¾Œç«¯æœå‹™
            html += '<div class="diagnostic-card">';
            html += '<div class="title">ğŸ”§ æ¸¬è©¦ 1: å¾Œç«¯æœå‹™ç‹€æ…‹</div>';
            
            try {
                const response = await fetch('http://localhost:3001/api/health');
                if (response.ok) {
                    const data = await response.json();
                    html += '<div class="test-result pass">âœ… å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ</div>';
                    html += `<div class="log-entry">æœå‹™æ™‚é–“: ${data.timestamp}</div>`;
                } else {
                    html += '<div class="test-result fail">âŒ å¾Œç«¯æœå‹™éŸ¿æ‡‰ç•°å¸¸</div>';
                }
            } catch (error) {
                html += '<div class="test-result fail">âŒ å¾Œç«¯æœå‹™ç„¡æ³•é€£æ¥</div>';
                html += `<div class="log-entry">éŒ¯èª¤: ${error.message}</div>`;
            }
            html += '</div>';

            // æ¸¬è©¦ 2: çˆ¬èŸ²åŠŸèƒ½
            html += '<div class="diagnostic-card">';
            html += '<div class="title">ğŸ•·ï¸ æ¸¬è©¦ 2: çˆ¬èŸ²åŠŸèƒ½</div>';
            
            try {
                const testSymbols = ['006208', '00921'];
                const results = await TestStockCrawlerService.fetchMultipleStocks(testSymbols);
                
                if (results.length > 0) {
                    html += '<div class="test-result pass">âœ… çˆ¬èŸ²åŠŸèƒ½æ­£å¸¸</div>';
                    results.forEach(stock => {
                        html += `<div class="log-entry">${stock.symbol}: ${stock.name} - $${stock.currentPrice}</div>`;
                    });
                } else {
                    html += '<div class="test-result fail">âŒ çˆ¬èŸ²æ²’æœ‰è¿”å›çµæœ</div>';
                }
            } catch (error) {
                html += '<div class="test-result fail">âŒ çˆ¬èŸ²åŠŸèƒ½å¤±æ•—</div>';
                html += `<div class="log-entry">éŒ¯èª¤: ${error.message}</div>`;
            }
            html += '</div>';

            // æ¸¬è©¦ 3: è‡ªå‹•æ›´æ–°é‚è¼¯
            html += '<div class="diagnostic-card">';
            html += '<div class="title">ğŸ”„ æ¸¬è©¦ 3: è‡ªå‹•æ›´æ–°é‚è¼¯</div>';
            
            const mockHoldings = { '006208': 289, '00921': 222 };
            const incompleteStocks = Object.keys(mockHoldings).filter(symbol => {
                // æ¨¡æ“¬æª¢æŸ¥é‚è¼¯
                return symbol === '00921'; // å‡è¨­ 00921 ç¼ºå°‘å®Œæ•´è³‡æ–™
            });

            if (incompleteStocks.length > 0) {
                html += '<div class="test-result pass">âœ… è‡ªå‹•æ›´æ–°é‚è¼¯æ­£å¸¸</div>';
                html += `<div class="log-entry">æª¢æ¸¬åˆ° ${incompleteStocks.length} æª”è‚¡ç¥¨éœ€è¦æ›´æ–°: ${incompleteStocks.join(', ')}</div>`;
            } else {
                html += '<div class="test-result">â„¹ï¸ æ‰€æœ‰è‚¡ç¥¨è³‡æ–™å®Œæ•´ï¼Œç„¡éœ€è‡ªå‹•æ›´æ–°</div>';
            }
            html += '</div>';

            // æ¸¬è©¦ 4: æ‰‹å‹•æ›´æ–°æµç¨‹
            html += '<div class="diagnostic-card">';
            html += '<div class="title">ğŸ”§ æ¸¬è©¦ 4: æ‰‹å‹•æ›´æ–°æµç¨‹</div>';
            html += '<div class="test-result pass">âœ… æ‰‹å‹•æ›´æ–°é‚è¼¯å·²ä¿®å¾©</div>';
            html += '<div class="log-entry">ä¿®å¾©: è®Šæ•¸å®šç¾©é †åºå•é¡Œå·²è§£æ±º</div>';
            html += '<div class="log-entry">ä¿®å¾©: autoUpdateWarehouseContent ç¾åœ¨åœ¨ä½¿ç”¨å‰å®šç¾©</div>';
            html += '</div>';

            resultsDiv.innerHTML = html;
        };

        window.testCrawler = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="diagnostic-card"><div class="title">ğŸ•·ï¸ æ¸¬è©¦çˆ¬èŸ²åŠŸèƒ½...</div></div>';

            try {
                const testSymbols = ['006208', '00713', '00878', '00921'];
                const results = await TestStockCrawlerService.fetchMultipleStocks(testSymbols);
                
                let html = '<div class="diagnostic-card success">';
                html += '<div class="title">ğŸ•·ï¸ çˆ¬èŸ²æ¸¬è©¦çµæœ</div>';
                html += `<div class="test-result pass">âœ… æˆåŠŸçˆ¬å– ${results.length}/${testSymbols.length} æª”è‚¡ç¥¨</div>`;
                
                results.forEach(stock => {
                    html += `<div class="log-entry">${stock.symbol}: ${stock.name} - $${stock.currentPrice} (${stock.change >= 0 ? '+' : ''}${stock.change})</div>`;
                });
                
                html += '</div>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="diagnostic-card error">
                        <div class="title">âŒ çˆ¬èŸ²æ¸¬è©¦å¤±æ•—</div>
                        <div class="test-result fail">éŒ¯èª¤: ${error.message}</div>
                    </div>
                `;
            }
        };

        window.testManualUpdate = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="diagnostic-card"><div class="title">ğŸ”§ æ¸¬è©¦æ‰‹å‹•æ›´æ–°...</div></div>';

            try {
                // æ¨¡æ“¬æ‰‹å‹•æ›´æ–°æµç¨‹
                const mockHoldings = { '006208': 289, '00713': 1133, '00921': 222 };
                const symbols = Object.keys(mockHoldings);
                
                // æ­¥é©Ÿ 1: çˆ¬å–è‚¡ç¥¨è³‡è¨Š
                const stockInfos = await TestStockCrawlerService.fetchMultipleStocks(symbols);
                
                // æ­¥é©Ÿ 2: ç”Ÿæˆ warehouse.md å…§å®¹
                const warehouseContent = symbols.map(symbol => {
                    const shares = mockHoldings[symbol];
                    const stockInfo = stockInfos.find(info => info.symbol === symbol);
                    
                    if (stockInfo) {
                        return `${symbol}\t${shares}\t${stockInfo.name}\t${stockInfo.currentPrice.toFixed(2)}\t${stockInfo.change.toFixed(2)}\t${stockInfo.changePercent.toFixed(2)}\t${stockInfo.lastUpdated}`;
                    } else {
                        return `${symbol}  ${shares}`;
                    }
                }).join('\n');

                let html = '<div class="diagnostic-card success">';
                html += '<div class="title">ğŸ”§ æ‰‹å‹•æ›´æ–°æ¸¬è©¦çµæœ</div>';
                html += '<div class="test-result pass">âœ… æ‰‹å‹•æ›´æ–°æµç¨‹æ­£å¸¸</div>';
                html += '<div class="test-result pass">âœ… è‚¡ç¥¨è³‡è¨Šçˆ¬å–æˆåŠŸ</div>';
                html += '<div class="test-result pass">âœ… warehouse.md å…§å®¹ç”ŸæˆæˆåŠŸ</div>';
                html += '<div class="title">ğŸ“„ ç”Ÿæˆçš„ warehouse.md å…§å®¹:</div>';
                html += `<div class="log-entry" style="white-space: pre-wrap;">${warehouseContent}</div>`;
                html += '</div>';
                
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="diagnostic-card error">
                        <div class="title">âŒ æ‰‹å‹•æ›´æ–°æ¸¬è©¦å¤±æ•—</div>
                        <div class="test-result fail">éŒ¯èª¤: ${error.message}</div>
                    </div>
                `;
            }
        };

        window.clearResults = () => {
            document.getElementById('results').innerHTML = '';
        };

        // è‡ªå‹•é–‹å§‹è¨ºæ–·
        setTimeout(runDiagnostics, 1000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦æ–°å¢è‚¡ç¥¨è‡ªå‹•æ›´æ–°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        .section {
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .title {
            font-size: 18px;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 10px;
        }
        .stock-row {
            background-color: #475569;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            font-family: monospace;
        }
        .complete { background-color: #065f46; }
        .incomplete { background-color: #7c2d12; }
        .new-stock { background-color: #1e40af; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        .highlight {
            background-color: #fbbf24;
            color: #1f2937;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ†• æ¸¬è©¦æ–°å¢è‚¡ç¥¨è‡ªå‹•æ›´æ–°åŠŸèƒ½</h1>
    
    <div class="section">
        <div class="title">ğŸ“‹ ç•¶å‰ warehouse.md ç‹€æ…‹</div>
        <div>æª¢æ¸¬åˆ°æ–°å¢è‚¡ç¥¨: <span class="highlight">00921</span> (åªæœ‰ä»£è™Ÿå’ŒæŒè‚¡æ•¸é‡ï¼Œç¼ºå°‘å®Œæ•´è³‡è¨Š)</div>
    </div>

    <button onclick="analyzeStocks()">ğŸ” åˆ†æè‚¡ç¥¨å®Œæ•´æ€§</button>
    <button onclick="testAutoUpdate()">ğŸš€ æ¸¬è©¦è‡ªå‹•æ›´æ–°é‚è¼¯</button>
    <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
    
    <div id="results"></div>

    <script type="module">
        // æ¨¡æ“¬ loadDetailedHoldingsFromWarehouse å‡½æ•¸
        const loadDetailedHoldingsFromWarehouse = async () => {
            try {
                const response = await fetch('/warehouse.md');
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è®€å– warehouse.md: ${response.status}`);
                }

                const content = await response.text();
                const holdings = [];

                const lines = content.split('\n').filter(line => line.trim());

                for (const line of lines) {
                    const parts = line.trim().split(/\t/);

                    if (parts.length >= 2) {
                        const symbol = parts[0];
                        const shares = parseInt(parts[1], 10);

                        if (!isNaN(shares) && shares > 0) {
                            const holding = {
                                symbol,
                                shares,
                                name: parts[2] || symbol,
                                currentPrice: parts[3] ? parseFloat(parts[3]) : undefined,
                                change: parts[4] ? parseFloat(parts[4]) : undefined,
                                changePercent: parts[5] ? parseFloat(parts[5]) : undefined,
                                lastUpdated: parts[6] || undefined
                            };
                            holdings.push(holding);
                        }
                    }
                }

                return holdings;
            } catch (error) {
                console.error('è®€å–è©³ç´°æŒè‚¡è³‡æ–™å¤±æ•—:', error);
                return [];
            }
        };

        window.analyzeStocks = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="warning">æ­£åœ¨åˆ†æè‚¡ç¥¨å®Œæ•´æ€§...</div>';

            try {
                const holdings = await loadDetailedHoldingsFromWarehouse();
                
                let html = `
                    <div class="section">
                        <div class="title">ğŸ“Š è‚¡ç¥¨å®Œæ•´æ€§åˆ†æ</div>
                        <div class="stock-row">
                            <strong>è‚¡ç¥¨ä»£è™Ÿ</strong>
                            <strong>æŒè‚¡æ•¸é‡</strong>
                            <strong>è³‡æ–™ç‹€æ…‹</strong>
                            <strong>éœ€è¦æ›´æ–°</strong>
                        </div>
                `;

                let completeCount = 0;
                let incompleteCount = 0;
                const incompleteStocks = [];

                holdings.forEach(stock => {
                    const hasName = stock.name && stock.name !== stock.symbol;
                    const hasPrice = stock.currentPrice && stock.currentPrice > 0;
                    const isComplete = hasName && hasPrice;
                    
                    if (isComplete) {
                        completeCount++;
                    } else {
                        incompleteCount++;
                        incompleteStocks.push(stock.symbol);
                    }

                    const rowClass = isComplete ? 'complete' : 
                                   (stock.symbol === '00921' ? 'new-stock' : 'incomplete');
                    const statusText = isComplete ? 'âœ… å®Œæ•´' : 'âŒ ä¸å®Œæ•´';
                    const needsUpdate = isComplete ? 'å¦' : 'æ˜¯';

                    html += `
                        <div class="stock-row ${rowClass}">
                            <span>${stock.symbol}</span>
                            <span>${stock.shares} è‚¡</span>
                            <span>${statusText}</span>
                            <span>${needsUpdate}</span>
                        </div>
                    `;
                });

                html += `
                    </div>
                    <div class="section">
                        <div class="title">ğŸ“ˆ çµ±è¨ˆçµæœ</div>
                        <div class="stock-row">
                            <span>å®Œæ•´è³‡æ–™: ${completeCount} æª”</span>
                            <span>ä¸å®Œæ•´è³‡æ–™: ${incompleteCount} æª”</span>
                            <span class="${incompleteCount > 0 ? 'warning' : 'success'}">
                                ${incompleteCount > 0 ? 'éœ€è¦è‡ªå‹•æ›´æ–°' : 'ç„¡éœ€æ›´æ–°'}
                            </span>
                            <span>æ–°å¢è‚¡ç¥¨: 00921</span>
                        </div>
                    </div>
                `;

                if (incompleteCount > 0) {
                    html += `
                        <div class="section">
                            <div class="title">ğŸ¯ é æœŸè‡ªå‹•æ›´æ–°è¡Œç‚º</div>
                            <div class="stock-row">
                                <span>æª¢æ¸¬çµæœ</span>
                                <span class="warning">ç™¼ç¾ ${incompleteCount} æª”ä¸å®Œæ•´è‚¡ç¥¨</span>
                                <span>è§¸ç™¼æ¢ä»¶</span>
                                <span class="success">âœ… æ‡‰è©²è§¸ç™¼è‡ªå‹•æ›´æ–°</span>
                            </div>
                            <div class="stock-row">
                                <span>æ›´æ–°ç­–ç•¥</span>
                                <span class="info">æ™ºèƒ½åˆä½µ</span>
                                <span>ä¿ç•™ç¾æœ‰</span>
                                <span class="success">å®Œæ•´è³‡æ–™ä¸è¢«è¦†è“‹</span>
                            </div>
                            <div class="stock-row">
                                <span>æ›´æ–°ç›®æ¨™</span>
                                <span class="highlight">${incompleteStocks.join(', ')}</span>
                                <span>é æœŸçµæœ</span>
                                <span class="success">ç²å¾—å®Œæ•´è‚¡ç¥¨è³‡è¨Š</span>
                            </div>
                        </div>
                    `;
                }

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ éŒ¯èª¤: ${error.message}</div>`;
            }
        };

        window.testAutoUpdate = async () => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="section">
                    <div class="title">ğŸš€ è‡ªå‹•æ›´æ–°é‚è¼¯æ¸¬è©¦</div>
                    <div class="stock-row">
                        <span>æ­¥é©Ÿ 1</span>
                        <span>è¼‰å…¥ warehouse.md</span>
                        <span>âœ… å®Œæˆ</span>
                        <span>è®€å–åˆ° 00921</span>
                    </div>
                    <div class="stock-row">
                        <span>æ­¥é©Ÿ 2</span>
                        <span>æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§</span>
                        <span class="warning">âŒ 00921 ç¼ºå°‘è³‡è¨Š</span>
                        <span>è§¸ç™¼æ›´æ–°æ¢ä»¶</span>
                    </div>
                    <div class="stock-row">
                        <span>æ­¥é©Ÿ 3</span>
                        <span>1.5ç§’å¾Œè‡ªå‹•æ›´æ–°</span>
                        <span class="info">â³ ç­‰å¾…ä¸­...</span>
                        <span>çˆ¬å– 00921 è³‡è¨Š</span>
                    </div>
                    <div class="stock-row">
                        <span>æ­¥é©Ÿ 4</span>
                        <span>æ™ºèƒ½åˆä½µè³‡æ–™</span>
                        <span class="success">âœ… ä¿ç•™ç¾æœ‰å®Œæ•´è³‡æ–™</span>
                        <span>åªæ›´æ–° 00921</span>
                    </div>
                </div>
                <div class="section">
                    <div class="title">ğŸ” æª¢æŸ¥æ–¹å¼</div>
                    <div>1. æ‰“é–‹ä¸»æ‡‰ç”¨ç¨‹å¼: <a href="http://localhost:5173/" target="_blank" style="color: #3b82f6;">http://localhost:5173/</a></div>
                    <div>2. è§€å¯Ÿæ˜¯å¦é¡¯ç¤ºã€Œæª¢æ¸¬åˆ° 1 æª”è‚¡ç¥¨ç¼ºå°‘å®Œæ•´è³‡æ–™: ['00921']ã€</div>
                    <div>3. ç­‰å¾…è‡ªå‹•æ›´æ–°å®Œæˆ</div>
                    <div>4. æª¢æŸ¥ 00921 æ˜¯å¦å‡ºç¾åœ¨æŒè‚¡å¡ç‰‡ä¸­ä¸¦æœ‰å®Œæ•´è³‡è¨Š</div>
                    <div>5. ç¢ºèªå…¶ä»–è‚¡ç¥¨çš„ç¾åƒ¹æ²’æœ‰è¢«è¦†è“‹</div>
                </div>
                <div class="section">
                    <div class="title">âœ… é æœŸçµæœ</div>
                    <div class="success">â€¢ 00921 ç²å¾—å®Œæ•´çš„è‚¡ç¥¨è³‡è¨Šï¼ˆåç¨±ã€ç¾åƒ¹ï¼‰</div>
                    <div class="success">â€¢ å…¶ä»–è‚¡ç¥¨çš„ç¾åƒ¹ä¿æŒä¸è®Šï¼ˆå¦‚ 006208=$110.25ï¼‰</div>
                    <div class="success">â€¢ é¡¯ç¤ºè‡ªå‹•æ›´æ–°æˆåŠŸé€šçŸ¥</div>
                    <div class="success">â€¢ æ‰€æœ‰è‚¡ç¥¨éƒ½å‡ºç¾åœ¨æŒè‚¡ç®¡ç†å¡ç‰‡ä¸­</div>
                </div>
            `;
        };

        window.clearResults = () => {
            document.getElementById('results').innerHTML = '';
        };

        // è‡ªå‹•åŸ·è¡Œåˆ†æ
        setTimeout(() => {
            analyzeStocks();
        }, 1000);
    </script>
</body>
</html>
